<!DOCTYPE html>
<html>
<head>
    <title>Car demo - p2.js physics engine</title>
    <script src="../build/p2.js"></script>
    <script src="../build/p2.renderer.js"></script>
    <link href="css/demo.css" rel="stylesheet"/>
    <meta name="description" content="How to make a simple box car with a motor.">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
</head>
<body>
    <script>
        MaxAngleDeg = 10;
        MaxAngleRad = MaxAngleDeg * Math.PI / 180;
        class Line {
            constructor(x, y, length=10, angle=0){
                this.x = x + length * Math.cos(angle) / 2;
                this.y = y + length * Math.sin(angle) / 2;
                this.length = length;
                this.angle = angle;
            }
            getEndpoint(){
                var xEndpoint = this.x + this.length*Math.cos(this.angle) / 2;
                var yEndpoint = this.y + this.length*Math.sin(this.angle) / 2;
                return [xEndpoint, yEndpoint];
            }
        }

        class Car {
            constructor(radius1, radius2, length){
                this.radius1 = radius1;
                this.radius2 = radius2;
                this.length = length;
            }
        }

        class CarObject{
            constructor(world, car){
                this.world = world;
                this.car = car;
                var xPosition = 1;
                var yPosition = 1;
                // Create chassis for our car
                var chassisBody = new p2.Body({
                    mass : 1,        // Setting mass > 0 makes it dynamic
                    position: [xPosition, yPosition] // Initial position
                });
                var chassisShape = new p2.Box({ width: car.length, height: 0.05 });
                chassisBody.addShape(chassisShape);
                world.addBody(chassisBody);
                this.chassis = chassisBody;
                // Create wheels
                var wheelBody1 = new p2.Body({ mass : 1, position:[chassisBody.position[0] - 0.5*car.length, yPosition] });
                var wheelBody2 = new p2.Body({ mass : 1, position:[chassisBody.position[0] + 0.5*car.length, yPosition] });
                var wheelShape1 = new p2.Circle({ radius: car.radius1 });
                var wheelShape2 = new p2.Circle({ radius: car.radius2 });
                wheelBody1.addShape(wheelShape1);
                wheelBody2.addShape(wheelShape2);
                world.addBody(wheelBody1);
                world.addBody(wheelBody2);
                // Constrain wheels to chassis with revolute constraints.
                // Revolutes lets the connected bodies rotate around a shared point.
                var revoluteBack = new p2.RevoluteConstraint(chassisBody, wheelBody1, {
                    localPivotA: [-0.5*car.length, 0],   // Where to hinge first wheel on the chassis
                    localPivotB: [0, 0],
                    collideConnected: false
                });
                var revoluteFront = new p2.RevoluteConstraint(chassisBody, wheelBody2, {
                    localPivotA: [0.5*car.length, 0], // Where to hinge second wheel on the chassis
                    localPivotB: [0, 0],      // Where the hinge is in the wheel (center)
                    collideConnected: false
                });
                world.addConstraint(revoluteBack);
                world.addConstraint(revoluteFront);
                // Enable the constraint motor for the back wheel
                revoluteBack.enableMotor();
                revoluteBack.setMotorSpeed(1); // Rotational speed in radians per second

                world.on("postStep", function() {
                    // console.log(chassisBody.position[0]);
                })
            }
        }

        function createTrack(numberOfLines){
            var lines = [];
            var lastX = 0;
            var lastY = 0;
            for (i=0; i<numberOfLines; i++){
                var line = new Line(lastX, lastY, 1, Math.random() * 2 * MaxAngleRad - MaxAngleRad);
                lines.push(line);
                endpoint = line.getEndpoint();
                lastX = endpoint[0];
                lastY = endpoint[1];
            }
            return lines;
        }

        // function renderTrack(world, numberOfLines){
        //     var lastX = 0;
        //     var lastY = 0;
        //     for (i=0; i<numberOfLines; i++){
        //         var line = new Line(lastX, lastY, 1, Math.random());
        //         endpoint = line.getEndpoint();
        //         lastX = endpoint[0];
        //         lastY = endpoint[1];
        //         draw = new p2.Line({length: draw.length});
        //         body = new p2.Body({position: draw.x, draw.y], angle: draw.angle});
        //         body.addShape(line);
        //         world.addBody(body);
        //     }
        // }

        // Create demo application
        var app = new p2.WebGLRenderer(function(){

            // Create a World
            var world = new p2.World({
                gravity: [0,-10] // Set gravity to -10 in y direction
            });

            this.setWorld(world);

            // Set high friction so the wheels don't slip
            world.defaultContactMaterial.friction = 100;

            //add the lines from the track
            
            var trackLength = 10;
            track = createTrack(trackLength);
            var notIgnore = [];
            for (i=0; i<trackLength; i++){
                line = new p2.Box({width: track[i].length, height: .1});
                body = new p2.Body({position: [track[i].x, track[i].y], angle: track[i].angle});
                body.addShape(line);
                world.addBody(body);

                notIgnore.push(body);
            }
            
            //renderTrack(world, 10);

            cars = [new CarObject(world, new Car(0.2, .2, .5)),
                    new CarObject(world, new Car(0.2, .2, .5))];

            this.frame(0, 0, 8, 6);

            this.followBody = cars[0].chassis;

            world.on('preSolve', function (evt){
                for (var i=0; i<evt.contactEquations.length; i++){
                    var eq = evt.contactEquations[i];
                    eq.enabled = notIgnore.includes(eq.bodyA) || notIgnore.includes(eq.bodyB);
                }
                for (var i=0; i<evt.frictionEquations.length; i++){
                    var eq = evt.frictionEquations[i];
                    eq.enabled = notIgnore.includes(eq.bodyA) || notIgnore.includes(eq.bodyB);
                }
            });

        });


    </script>
</body>
</html>
