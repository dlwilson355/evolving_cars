<!DOCTYPE html>
<html>
<head>
    <title>Evolving car shapes</title>
    <script src="js/p2.js"></script>
    <script src="js/p2.renderer.js"></script>
    <script src="js/cars.js"></script>
    <script src="js/evolution.js"></script>
    <link href="css/cars.css" rel="stylesheet"/>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
</head>
<body>
    <script>
        var app = new p2.WebGLRenderer(function() {
            console.log('New game');

            var game_start_time = Date.now();

            this.paused = false;
            var game_finished = false;
            var cars_to_remove = [];

            // ---------------
            // World set-up
            // ---------------

            // Create a World
            var world = new p2.World({
                gravity: [0,-10] // Set gravity to -10 in y direction
            });
            // Set high friction so the wheels don't slip
            world.defaultContactMaterial.friction = 100;
            this.setWorld(world);

            // Create a Track
            var track = new Track(100);
            track.add_to_world(world);

            // Create cars
            this.cars = [] // it's our population
            var cars_info = []
            for (var i = 0; i < 10; ++i) {
                var car = new Car({
                    radius_bw: 0.2,
                    radius_fw: 0.2,
                    length: Math.random(),
                    speed: Math.random() * 2 + 8 // [8 - 10)
                });
                car.add_to_world(world);
                cars_info.push({
                    "car": car,
                    "last_pos": car.get_position[0] // to check if the car's stuck
                });
                this.cars.push(car);
            }

            // ---------------
            // App set-up
            // ---------------
            this.frame(0, 0, 10, 10);
            this.gui.closed = true;

            this.check_stuck_cars = function() {
                for (var i = 0; i < cars_info.length; i++) {
                    pos = cars_info[i]["car"].get_position()[0];
                    last_pos = cars_info[i]["last_pos"];
                    if (Math.abs(pos - last_pos) < 0.01) {
                        cars_to_remove.push(cars_info[i]["car"]);
                        cars_info.splice(i, 1);
                    } else {
                        cars_info[i]["last_pos"] = pos;
                    }
                }
            }

            // Go to the next step of the world
            this.next_step = function() {
                this.settings['manualStep [s]']();
            }

            this.finish_game  = function() {
                if (game_finished) {
                    return;
                }
                game_finished = true;
                // if finish while paused, everything falls apart
                // in physics engine (no errors though)
                this.paused = false;

                while (true) {
                    for (var i = 0; i < 10; i++) {
                        this.next_step();
                    }
                    this.check_stuck_cars();
                    var flag = false;
                    for (var i = 0; i < this.cars.length; i++) {
                        if (!this.cars[i].removed) {
                            flag = true;
                            break;
                        }
                    }
                    if (flag) continue;
                    break;
                }
                this.paused = true;
                console.log('Game over');
                console.log('Game duration (msec.):', Date.now() - game_start_time);
                do_evolution(this.cars);
                this.new_game();
            }

            this.new_game = function() {
                this.setSceneByIndex(0);
            }

            // Remove stuck cars each 1 sec
            setInterval(this.check_stuck_cars, 1000);

            // Event listeners
            world.on("beginContact", function (event) {
                // We cannot remove the body here since the world is still stepping.
                // Instead, schedule the body to be removed after the step is done.
                if (track.bucket.includes(event.bodyA) || track.bucket.includes(event.bodyB)) {
                    var car_ix = -1;
                    for (var j = 0; j < cars_info.length; j++) {
                        car = cars_info[j]["car"];
                        if (car.has_body(event.bodyA) || car.has_body(event.bodyB)) {
                            car_ix = j;
                            break;
                        }
                    }
                    if (car_ix >= 0) {
                        cars_to_remove.push(cars_info[car_ix]["car"]);
                        cars_info.splice(car_ix, 1);
                    } else {
                        console.log('WTF');
                    }
                }
            });

            world.on("postStep", function (event) {
                // If car finished
                for (var i = 0; i < cars_to_remove.length; i++) {
                    // Remove the body from the world.
                    remove_car = cars_to_remove[i];
                    remove_car.remove_from_world();
                }
                cars_to_remove = [];

                // find the first car to follow
                first_car_ix = 0;
                for (var i = 1; i < cars_info.length; i++) {
                    pos1 = cars_info[first_car_ix]["car"].get_position()[0];
                    pos2 = cars_info[i]["car"].get_position()[0];
                    if (pos2 > pos1) {
                        first_car_ix = i;
                    }
                }

                // follow the 1st car or reset the game if no cars left
                if (cars_info.length == 0) {
                    // The game has ended! Restart!
                    app.finish_game();
                } else {
                    app.followBody = cars_info[first_car_ix]["car"].get_center_body();
                }
            });
        });

        document.onkeydown = function(evt) {
            evt = evt || window.event;
            if (evt.key == " ") { // space
                app.finish_game();
            } else if (evt.key == 'f') {
                for (var i = 0; i < 5; i++) {
                    app.finish_game();
                }
            }
        };
    </script>
</body>
</html>
